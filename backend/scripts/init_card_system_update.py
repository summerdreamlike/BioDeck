#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
å¡ç‰Œç³»ç»Ÿæ›´æ–°åˆå§‹åŒ–è„šæœ¬
"""

import sqlite3
import sys
import os
from datetime import datetime

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

def init_card_system_update():
    """åˆå§‹åŒ–å¡ç‰Œç³»ç»Ÿæ›´æ–°"""
    print("æ­£åœ¨æ›´æ–°å¡ç‰Œç³»ç»Ÿ...")
    
    # ä½¿ç”¨ç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•çš„æ•°æ®åº“è·¯å¾„
    db_path = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), 'database.db')
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    
    try:
        # 1. æ·»åŠ ç§¯åˆ†å­—æ®µåˆ°usersè¡¨
        print("1. æ›´æ–°usersè¡¨ç»“æ„...")
        
        # æ£€æŸ¥å¹¶æ·»åŠ pointså­—æ®µ
        cursor.execute("PRAGMA table_info(users)")
        columns = [column[1] for column in cursor.fetchall()]
        
        if 'points' not in columns:
            cursor.execute('ALTER TABLE users ADD COLUMN points INTEGER DEFAULT 100')
            print("   âœ“ æ·»åŠ pointså­—æ®µ")
        else:
            print("   âœ“ pointså­—æ®µå·²å­˜åœ¨")
        
        # 2. æ›´æ–°ç°æœ‰ç”¨æˆ·çš„ç§¯åˆ†
        print("2. æ›´æ–°ç°æœ‰ç”¨æˆ·ç§¯åˆ†...")
        cursor.execute('UPDATE users SET points = 100 WHERE points IS NULL OR points < 100')
        updated_count = cursor.rowcount
        print(f"   âœ“ æ›´æ–°äº† {updated_count} ä¸ªç”¨æˆ·çš„ç§¯åˆ†")
        
        # 3. æ¸…ç©ºå¹¶é‡æ–°åˆå§‹åŒ–å¡ç‰Œå®šä¹‰
        print("3. é‡æ–°åˆå§‹åŒ–å¡ç‰Œå®šä¹‰...")
        cursor.execute('DELETE FROM card_definitions')
        cursor.execute('DELETE FROM rarity_drop_config')
        print("   âœ“ æ¸…ç©ºæ—§å¡ç‰Œæ•°æ®")
        
        # 4. é‡æ–°åˆ›å»ºå¡ç‰Œå®šä¹‰è¡¨
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS card_definitions_new (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                card_id TEXT NOT NULL UNIQUE,
                name TEXT NOT NULL,
                description TEXT,
                rarity TEXT NOT NULL,
                image_url TEXT,
                points_cost INTEGER NOT NULL DEFAULT 100,
                drop_rate REAL NOT NULL DEFAULT 0.1,
                created_at DATETIME DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # 5. æ’å…¥æ–°çš„å¡ç‰Œå®šä¹‰
        new_cards = [
            # Bçº§å¡ç‰Œ (B) - åŸºç¡€ç”Ÿç‰©å­¦æ¦‚å¿µ
            ('B001', 'ç§ç¾¤å¯†åº¦', 'ç§ç¾¤åœ¨å•ä½é¢ç§¯æˆ–å•ä½ä½“ç§¯ä¸­çš„ä¸ªä½“æ•°é‡ï¼Œæ˜¯ç”Ÿæ€å­¦ç ”ç©¶çš„é‡è¦å‚æ•°', 'B', 'assets/img/Decks/Bå¡/ç§ç¾¤å¯†åº¦.png', 100, 0.35),
            ('B002', 'ååŠ©æ‰©æ•£', 'ç‰©è´¨åœ¨è½½ä½“è›‹ç™½å¸®åŠ©ä¸‹é¡ºæµ“åº¦æ¢¯åº¦è·¨è†œè¿è¾“çš„è¿‡ç¨‹ï¼Œä¸æ¶ˆè€—èƒ½é‡', 'B', 'assets/img/Decks/Bå¡/ååŠ©æ‰©æ•£.png', 100, 0.35),
            ('B003', 'æ ¸ç³–ä½“', 'ç»†èƒä¸­è›‹ç™½è´¨åˆæˆçš„åœºæ‰€ï¼Œç”±rRNAå’Œè›‹ç™½è´¨ç»„æˆ', 'B', 'assets/img/Decks/Bå¡/æ ¸ç³–ä½“.png', 100, 0.35),
            ('B004', 'ç»†èƒå­¦è¯´å¥ åŸº', 'æ–½è±ç™»å’Œæ–½æ—ºæå‡ºçš„ç»†èƒå­¦è¯´ï¼Œå¥ å®šäº†ç°ä»£ç”Ÿç‰©å­¦çš„åŸºç¡€', 'B', 'assets/img/Decks/Bå¡/ç»†èƒå­¦è¯´å¥ åŸº.png', 100, 0.35),
            
            # Açº§å¡ç‰Œ (A) - é‡è¦ç”Ÿç‰©å­¦æ¦‚å¿µ
            ('A001', 'èµ¤éœ‰ç´ ', 'æ¤ç‰©æ¿€ç´ ï¼Œä¿ƒè¿›æ¤ç‰©ç”Ÿé•¿å’Œå‘è‚²ï¼Œå½±å“ç§å­èŒå‘å’ŒèŒçš„ä¼¸é•¿', 'A', 'assets/img/Decks/Aå¡/èµ¤éœ‰ç´ .png', 300, 0.25),
            ('A002', 'é…¸ç¢±å¹³è¡¡', 'ç”Ÿç‰©ä½“å†…pHå€¼çš„ç›¸å¯¹ç¨³å®šçŠ¶æ€ï¼Œå¯¹ç”Ÿå‘½æ´»åŠ¨è‡³å…³é‡è¦', 'A', 'assets/img/Decks/Aå¡/é…¸ç¢±å¹³è¡¡.png', 300, 0.25),
            ('A003', 'å•åŸºå› é—ä¼ ç—…', 'ç”±å•ä¸ªåŸºå› çªå˜å¼•èµ·çš„é—ä¼ æ€§ç–¾ç—…ï¼Œå¦‚ç™½åŒ–ç—…ã€è¡€å‹ç—…ç­‰', 'A', 'assets/img/Decks/Aå¡/å•åŸºå› é—ä¼ ç—….png', 300, 0.25),
            ('A004', 'ç‚¹çªå˜', 'DNAåˆ†å­ä¸­å•ä¸ªç¢±åŸºå¯¹çš„æ”¹å˜ï¼Œå¯èƒ½å¯¼è‡´åŸºå› åŠŸèƒ½çš„æ”¹å˜', 'A', 'assets/img/Decks/Aå¡/ç‚¹çªå˜.png', 300, 0.25),
            ('A005', 'ç¨‹åºæ€§æ­»äº¡', 'ç»†èƒåœ¨ç‰¹å®šä¿¡å·è¯±å¯¼ä¸‹çš„ä¸»åŠ¨æ­»äº¡è¿‡ç¨‹ï¼Œå¯¹ç”Ÿç‰©å‘è‚²å¾ˆé‡è¦', 'A', 'assets/img/Decks/Aå¡/ç¨‹åºæ€§æ­»äº¡.png', 300, 0.25),
            ('A006', 'ä¸»åŠ¨è¿è¾“', 'ç‰©è´¨é€†æµ“åº¦æ¢¯åº¦è·¨è†œè¿è¾“çš„è¿‡ç¨‹ï¼Œéœ€è¦è½½ä½“è›‹ç™½å’Œèƒ½é‡', 'A', 'assets/img/Decks/Aå¡/ä¸»åŠ¨è¿è¾“.png', 300, 0.25),
            ('A007', 'ç”Ÿç‰©å‚¬åŒ–å‰‚', 'é…¶ï¼Œç”Ÿç‰©ä½“å†…å‚¬åŒ–å„ç§ç”ŸåŒ–ååº”çš„è›‹ç™½è´¨ï¼Œå…·æœ‰é«˜æ•ˆæ€§å’Œä¸“ä¸€æ€§', 'A', 'assets/img/Decks/Aå¡/ç”Ÿç‰©å‚¬åŒ–å‰‚.png', 300, 0.25),
            ('A008', 'ç»†èƒè†œ', 'ç»†èƒçš„åŸºæœ¬ä¿æŠ¤å±éšœï¼Œæ§åˆ¶ç‰©è´¨è¿›å‡ºï¼Œç»´æŒç»†èƒå†…ç¯å¢ƒç¨³å®š', 'A', 'assets/img/Decks/Aå¡/ç»†èƒè†œ.png', 300, 0.25),
            ('A009', 'ç£·è„‚åŒåˆ†å­å±‚', 'ç»†èƒè†œçš„åŸºæœ¬éª¨æ¶ï¼Œç”±ç£·è„‚åˆ†å­æ’åˆ—æˆåŒå±‚ç»“æ„', 'A', 'assets/img/Decks/Aå¡/ç£·è„‚åŒåˆ†å­å±‚.png', 300, 0.25),
            ('A010', 'è›‹ç™½è´¨', 'ç”Ÿå‘½æ´»åŠ¨çš„ä¸»è¦æ‰¿æ‹…è€…ï¼Œå‚ä¸ç»†èƒç»“æ„ã€ä»£è°¢è°ƒèŠ‚ã€å…ç–«ç­‰å¤šç§åŠŸèƒ½', 'A', 'assets/img/Decks/Aå¡/è›‹ç™½è´¨.png', 300, 0.25),
            ('A011', 'å¶ç»¿ä½“', 'æ¤ç‰©ç»†èƒä¸­è¿›è¡Œå…‰åˆä½œç”¨çš„ç»†èƒå™¨ï¼Œå«æœ‰å¶ç»¿ç´ ', 'A', 'assets/img/Decks/Aå¡/å¶ç»¿ä½“.png', 300, 0.25),
            
            # Rçº§å¡ç‰Œ (R) - è¿›é˜¶ç”Ÿç‰©å­¦æ¦‚å¿µ
            ('R001', 'é£Ÿç‰©é“¾', 'ç”Ÿç‰©ä¹‹é—´é€šè¿‡æ•é£Ÿå…³ç³»å½¢æˆçš„è¥å…»å…³ç³»é“¾ï¼Œä½“ç°èƒ½é‡æµåŠ¨', 'R', 'assets/img/Decks/Rå¡/é£Ÿç‰©é“¾.png', 600, 0.20),
            ('R002', 'ç”Ÿé•¿ç´ ', 'æ¤ç‰©æ¿€ç´ ï¼Œä¿ƒè¿›ç»†èƒä¼¸é•¿å’Œåˆ†åŒ–ï¼Œå½±å“æ¤ç‰©å‘å…‰æ€§', 'R', 'assets/img/Decks/Rå¡/ç”Ÿé•¿ç´ .png', 600, 0.20),
            ('R003', 'æ¿€ç´ è°ƒèŠ‚', 'ç”Ÿç‰©ä½“å†…é€šè¿‡æ¿€ç´ è¿›è¡Œçš„ä¿¡æ¯ä¼ é€’å’Œç”Ÿç†è°ƒèŠ‚æœºåˆ¶', 'R', 'assets/img/Decks/Rå¡/æ¿€ç´ è°ƒèŠ‚.png', 600, 0.20),
            ('R004', 'åå°„å¼§', 'ç¥ç»è°ƒèŠ‚çš„åŸºæœ¬ç»“æ„ï¼ŒåŒ…æ‹¬æ„Ÿå—å™¨ã€ä¼ å…¥ç¥ç»ã€ç¥ç»ä¸­æ¢ã€ä¼ å‡ºç¥ç»å’Œæ•ˆåº”å™¨', 'R', 'assets/img/Decks/Rå¡/åå°„å¼§.png', 600, 0.20),
            ('R005', 'æŸ“è‰²ä½“å¼‚å¸¸é—ä¼ ç—…', 'ç”±æŸ“è‰²ä½“ç»“æ„æˆ–æ•°ç›®å¼‚å¸¸å¼•èµ·çš„é—ä¼ æ€§ç–¾ç—…ï¼Œå¦‚å”æ°ç»¼åˆå¾', 'R', 'assets/img/Decks/Rå¡/æŸ“è‰²ä½“å¼‚å¸¸é—ä¼ ç—….png', 600, 0.20),
            ('R006', 'å¤šåŸºå› é—ä¼ ç—…', 'ç”±å¤šä¸ªåŸºå› å…±åŒä½œç”¨å¼•èµ·çš„é—ä¼ æ€§ç–¾ç—…ï¼Œå¦‚é«˜è¡€å‹ã€ç³–å°¿ç—…ç­‰', 'R', 'assets/img/Decks/Rå¡/å¤šåŸºå› é—ä¼ ç—….png', 600, 0.20),
            ('R007', 'æŸ“è‰²ä½“ç»“æ„å˜å¼‚', 'æŸ“è‰²ä½“å‘ç”Ÿæ–­è£‚ã€ç¼ºå¤±ã€é‡å¤ã€å€’ä½ã€æ˜“ä½ç­‰ç»“æ„æ”¹å˜', 'R', 'assets/img/Decks/Rå¡/æŸ“è‰²ä½“ç»“æ„å˜å¼‚.png', 600, 0.20),
            ('R008', 'åˆ†ç¦»å®šå¾‹', 'å­Ÿå¾·å°”ç¬¬ä¸€å®šå¾‹ï¼Œæ§åˆ¶ä¸€å¯¹ç›¸å¯¹æ€§çŠ¶çš„åŸºå› åœ¨å½¢æˆé…å­æ—¶åˆ†ç¦»', 'R', 'assets/img/Decks/Rå¡/åˆ†ç¦»å®šå¾‹.png', 600, 0.20),
            ('R009', 'ç»†èƒå…¨èƒ½æ€§', 'ç»†èƒå…·æœ‰å‘è‚²æˆå®Œæ•´ä¸ªä½“çš„æ½œåœ¨èƒ½åŠ›ï¼Œæ˜¯å…‹éš†æŠ€æœ¯çš„åŸºç¡€', 'R', 'assets/img/Decks/Rå¡/ç»†èƒå…¨èƒ½æ€§.png', 600, 0.20),
            ('R010', 'æ— æ°§å‘¼å¸', 'åœ¨æ— æ°§æ¡ä»¶ä¸‹ï¼Œæœ‰æœºç‰©ä¸å®Œå…¨æ°§åŒ–åˆ†è§£äº§ç”Ÿèƒ½é‡çš„è¿‡ç¨‹', 'R', 'assets/img/Decks/Rå¡/æ— æ°§å‘¼å¸.png', 600, 0.20),
            ('R011', 'çº¿ç²’ä½“', 'ç»†èƒè¿›è¡Œæœ‰æ°§å‘¼å¸çš„ä¸»è¦åœºæ‰€ï¼Œè¢«ç§°ä¸ºç»†èƒçš„èƒ½é‡å·¥å‚', 'R', 'assets/img/Decks/Rå¡/çº¿ç²’ä½“.png', 600, 0.20),
            ('R012', 'èƒ½é‡è´§å¸', 'ATPï¼Œç»†èƒä¸­å‚¨å­˜å’Œä¼ é€’èƒ½é‡çš„ä¸»è¦åˆ†å­', 'R', 'assets/img/Decks/Rå¡/èƒ½é‡è´§å¸.png', 600, 0.20),
            
            # SRçº§å¡ç‰Œ (SR) - é«˜çº§ç”Ÿç‰©å­¦æ¦‚å¿µ
            ('SR001', 'ç¿»è¯‘', 'ä»¥mRNAä¸ºæ¨¡æ¿ï¼Œåœ¨æ ¸ç³–ä½“ä¸Šåˆæˆè›‹ç™½è´¨çš„è¿‡ç¨‹', 'SR', 'assets/img/Decks/SRå¡/ç¿»è¯‘.png', 1200, 0.15),
            ('SR002', 'é£Ÿç‰©ç½‘', 'å¤šä¸ªé£Ÿç‰©é“¾ç›¸äº’äº¤ç»‡å½¢æˆçš„å¤æ‚è¥å…»å…³ç³»ç½‘ç»œ', 'SR', 'assets/img/Decks/SRå¡/é£Ÿç‰©ç½‘.png', 1200, 0.15),
            ('SR003', 'ç°ä»£ç”Ÿç‰©è¿›åŒ–ç†è®º', 'ç»¼åˆäº†è‡ªç„¶é€‰æ‹©ã€é—ä¼ å˜å¼‚ã€åŸºå› é¢‘ç‡å˜åŒ–ç­‰å†…å®¹çš„è¿›åŒ–ç†è®º', 'SR', 'assets/img/Decks/SRå¡/ç°ä»£ç”Ÿç‰©è¿›åŒ–ç†è®º.png', 1200, 0.15),
            ('SR004', 'æŸ“è‰²ä½“æ•°ç›®å˜å¼‚', 'æŸ“è‰²ä½“æ•°ç›®å‘ç”Ÿæ”¹å˜ï¼Œå¦‚å¤šå€ä½“ã€å•å€ä½“ç­‰', 'SR', 'assets/img/Decks/SRå¡/æŸ“è‰²ä½“æ•°ç›®å˜å¼‚.png', 1200, 0.15),
            ('SR005', 'è½¬å½•', 'ä»¥DNAä¸ºæ¨¡æ¿ï¼Œåœ¨RNAèšåˆé…¶å‚¬åŒ–ä¸‹åˆæˆRNAçš„è¿‡ç¨‹', 'SR', 'assets/img/Decks/SRå¡/è½¬å½•.png', 1200, 0.15),
            ('SR006', 'åŠä¿ç•™å¤åˆ¶', 'DNAå¤åˆ¶æ—¶ï¼Œæ¯æ¡å­é“¾éƒ½ä¿ç•™ä¸€æ¡æ¯é“¾çš„å¤åˆ¶æ–¹å¼', 'SR', 'assets/img/Decks/SRå¡/åŠä¿ç•™å¤åˆ¶.png', 1200, 0.15),
            ('SR007', 'ä¼´Xé—ä¼ ', 'åŸºå› ä½äºXæŸ“è‰²ä½“ä¸Šçš„é—ä¼ æ–¹å¼ï¼Œå¦‚çº¢ç»¿è‰²ç›²ã€è¡€å‹ç—…ç­‰', 'SR', 'assets/img/Decks/SRå¡/ä¼´Xé—ä¼ .png', 1200, 0.15),
            ('SR008', 'è‡ªç”±ç»„åˆå®šå¾‹', 'å­Ÿå¾·å°”ç¬¬äºŒå®šå¾‹ï¼Œæ§åˆ¶ä¸åŒæ€§çŠ¶çš„åŸºå› åœ¨å½¢æˆé…å­æ—¶è‡ªç”±ç»„åˆ', 'SR', 'assets/img/Decks/SRå¡/è‡ªç”±ç»„åˆå®šå¾‹.png', 1200, 0.15),
            ('SR009', 'æœ‰ä¸åˆ†è£‚', 'çœŸæ ¸ç»†èƒè¿›è¡Œç»†èƒåˆ†è£‚çš„ä¸»è¦æ–¹å¼ï¼Œä¿è¯é—ä¼ ç‰©è´¨çš„å‡†ç¡®åˆ†é…', 'SR', 'assets/img/Decks/SRå¡/æœ‰ä¸åˆ†è£‚.png', 1200, 0.15),
            ('SR010', 'æš—ååº”', 'å…‰åˆä½œç”¨ä¸­ä¸ä¾èµ–å…‰çš„åŒ–å­¦ååº”ï¼Œå›ºå®šCO2åˆæˆæœ‰æœºç‰©', 'SR', 'assets/img/Decks/SRå¡/æš—ååº”.png', 1200, 0.15),
            ('SR011', 'å…‰ååº”', 'å…‰åˆä½œç”¨ä¸­ä¾èµ–å…‰çš„ååº”ï¼Œå°†å…‰èƒ½è½¬åŒ–ä¸ºåŒ–å­¦èƒ½', 'SR', 'assets/img/Decks/SRå¡/å…‰ååº”.png', 1200, 0.15),
            ('SR012', 'æœ‰æ°§å‘¼å¸', 'åœ¨æ°§æ°”å‚ä¸ä¸‹ï¼Œæœ‰æœºç‰©å½»åº•æ°§åŒ–åˆ†è§£äº§ç”Ÿå¤§é‡èƒ½é‡çš„è¿‡ç¨‹', 'SR', 'assets/img/Decks/SRå¡/æœ‰æ°§å‘¼å¸.png', 1200, 0.15),
            
            # URçº§å¡ç‰Œ (UR) - é¡¶çº§ç”Ÿç‰©å­¦æ¦‚å¿µ
            ('UR001', 'ç‰©è´¨å¾ªç¯', 'ç”Ÿç‰©åœˆä¸­ç‰©è´¨åœ¨ç”Ÿç‰©ä¸éç”Ÿç‰©ç¯å¢ƒä¹‹é—´çš„å¾ªç¯è¿‡ç¨‹ï¼Œç»´æŒç”Ÿæ€ç³»ç»Ÿçš„ç‰©è´¨å¹³è¡¡', 'UR', 'assets/img/Decks/URå¡/ç‰©è´¨å¾ªç¯.png', 2500, 0.05),
            ('UR002', 'ç”Ÿç‰©å¤šæ ·æ€§', 'åœ°çƒä¸Šæ‰€æœ‰ç”Ÿç‰©ç§ç±»ã€åŸºå› å’Œç”Ÿæ€ç³»ç»Ÿçš„ä¸°å¯Œç¨‹åº¦ï¼Œæ˜¯ç”Ÿå‘½è¿›åŒ–çš„å®è´µè´¢å¯Œ', 'UR', 'assets/img/Decks/URå¡/ç”Ÿç‰©å¤šæ ·æ€§.png', 2500, 0.05),
            ('UR003', 'èƒ½é‡æµåŠ¨', 'ç”Ÿæ€ç³»ç»Ÿä¸­èƒ½é‡ä»ç”Ÿäº§è€…åˆ°æ¶ˆè´¹è€…çš„å•å‘æµåŠ¨è¿‡ç¨‹ï¼Œé©±åŠ¨æ•´ä¸ªç”Ÿå‘½ç³»ç»Ÿçš„è¿è½¬', 'UR', 'assets/img/Decks/URå¡/èƒ½é‡æµåŠ¨.png', 2500, 0.05),
            ('UR004', 'è‡ªç„¶é€‰æ‹©', 'è¾¾å°”æ–‡è¿›åŒ–è®ºçš„æ ¸å¿ƒæœºåˆ¶ï¼Œé€‚è€…ç”Ÿå­˜ï¼Œä¸é€‚è€…è¢«æ·˜æ±°çš„è‡ªç„¶è¿‡ç¨‹', 'UR', 'assets/img/Decks/URå¡/è‡ªç„¶é€‰æ‹©.png', 2500, 0.05),
            ('UR005', 'å‡æ•°åˆ†è£‚', 'ç”Ÿæ®–ç»†èƒå½¢æˆè¿‡ç¨‹ä¸­çš„ç‰¹æ®Šç»†èƒåˆ†è£‚æ–¹å¼ï¼Œäº§ç”Ÿå•å€ä½“é…å­', 'UR', 'assets/img/Decks/URå¡/å‡æ•°åˆ†è£‚.png', 2500, 0.05),
        ]
        
        cursor.executemany('''
            INSERT INTO card_definitions_new (card_id, name, description, rarity, image_url, points_cost, drop_rate)
            VALUES (?, ?, ?, ?, ?, ?, ?)
        ''', new_cards)
        print(f"   âœ“ æ’å…¥äº† {len(new_cards)} å¼ æ–°å¡ç‰Œ")
        
        # 6. æ’å…¥æ–°çš„ç¨€æœ‰åº¦æ¦‚ç‡é…ç½®
        new_rarity_rates = [
            ('B', 0.35),
            ('A', 0.25),
            ('R', 0.20),
            ('SR', 0.15),
            ('UR', 0.05)
        ]
        
        print("   âœ“ ç¨€æœ‰åº¦æ¦‚ç‡é…ç½®:")
        print("      â€¢ Bçº§: 35% (4å¼ )")
        print("      â€¢ Açº§: 25% (11å¼ )")
        print("      â€¢ Rçº§: 20% (12å¼ )")
        print("      â€¢ SRçº§: 15% (12å¼ )")
        print("      â€¢ URçº§: 5% (5å¼ )")
        
        cursor.executemany('INSERT INTO rarity_drop_config (rarity, rate) VALUES (?, ?)', new_rarity_rates)
        print("   âœ“ æ›´æ–°äº†ç¨€æœ‰åº¦æ¦‚ç‡é…ç½®")
        
        # 7. æ›¿æ¢æ—§è¡¨
        cursor.execute('DROP TABLE IF EXISTS card_definitions')
        cursor.execute('ALTER TABLE card_definitions_new RENAME TO card_definitions')
        print("   âœ“ æ›´æ–°äº†å¡ç‰Œå®šä¹‰è¡¨")
        
        # 8. åˆ›å»ºç´¢å¼•
        cursor.execute('CREATE INDEX IF NOT EXISTS idx_card_rarity ON card_definitions(rarity)')
        cursor.execute('CREATE INDEX IF NOT EXISTS idx_card_id ON card_definitions(card_id)')
        print("   âœ“ åˆ›å»ºäº†æ•°æ®åº“ç´¢å¼•")
        
        conn.commit()
        print("\nâœ… å¡ç‰Œç³»ç»Ÿæ›´æ–°å®Œæˆï¼")
        
        # æ˜¾ç¤ºæ›´æ–°åçš„ç»Ÿè®¡ä¿¡æ¯
        cursor.execute('SELECT COUNT(*) FROM card_definitions')
        card_count = cursor.fetchone()[0]
        
        cursor.execute('SELECT COUNT(*) FROM users')
        user_count = cursor.fetchone()[0]
        
        print(f"\nğŸ“Š æ›´æ–°ç»Ÿè®¡:")
        print(f"   - å¡ç‰Œæ€»æ•°: {card_count}")
        print(f"   - ç”¨æˆ·æ€»æ•°: {user_count}")
        print(f"   - ç¨€æœ‰åº¦åˆ†å¸ƒ:")
        print(f"     â€¢ Bçº§å¡ç‰Œ: 4å¼  (35%) - åŸºç¡€ç”Ÿç‰©å­¦æ¦‚å¿µ")
        print(f"     â€¢ Açº§å¡ç‰Œ: 11å¼  (25%) - é‡è¦ç”Ÿç‰©å­¦æ¦‚å¿µ")
        print(f"     â€¢ Rçº§å¡ç‰Œ: 12å¼  (20%) - è¿›é˜¶ç”Ÿç‰©å­¦æ¦‚å¿µ")
        print(f"     â€¢ SRçº§å¡ç‰Œ: 12å¼  (15%) - é«˜çº§ç”Ÿç‰©å­¦æ¦‚å¿µ")
        print(f"     â€¢ URçº§å¡ç‰Œ: 5å¼  (5%) - é¡¶çº§ç”Ÿç‰©å­¦æ¦‚å¿µ")
        print(f"   - æŠ½å¡è´¹ç”¨: å•æŠ½100ç§¯åˆ†, åæŠ½900ç§¯åˆ†")
        print(f"   - æ€»è®¡: 42å¼ ç”Ÿç‰©å­¦ä¸»é¢˜å¡ç‰Œ")
        
    except Exception as e:
        conn.rollback()
        print(f"\nâŒ æ›´æ–°å¤±è´¥: {str(e)}")
        raise
    finally:
        conn.close()

if __name__ == '__main__':
    try:
        init_card_system_update()
    except Exception as e:
        print(f"åˆå§‹åŒ–å¤±è´¥: {str(e)}")
        sys.exit(1) 
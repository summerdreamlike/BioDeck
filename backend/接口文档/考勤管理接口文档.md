# 考勤管理接口文档

## 目录

- [1. 基本信息](#1-基本信息)
- [2. 考勤记录管理](#2-考勤记录管理)
- [3. 学生签到](#3-学生签到)
- [4. 考勤统计](#4-考勤统计)
- [5. 签到码管理](#5-签到码管理)

---

## 1. 基本信息

- **模块名称**: 考勤管理
- **API前缀**: `/api/v1/attendance`
- **功能描述**: 管理学生的考勤记录、签到、统计和签到码生成
- **部署说明**: 系统已修复导入路径问题，确保在backend目录下运行

---

## 2. 考勤记录管理

### 2.1 获取考勤记录列表

**接口地址**: `GET /attendance`

**接口描述**: 获取考勤记录列表，支持分页和筛选

**权限要求**: admin、teacher

**查询参数**:
- `page`: 页码（默认1）
- `page_size`: 每页大小（默认20）
- `student_id`: 学生ID筛选
- `course_id`: 课程ID筛选
- `date`: 日期筛选（YYYY-MM-DD）
- `status`: 考勤状态筛选（present/absent/late）

**成功响应**:
```json
{
  "success": true,
  "message": "获取成功",
  "data": {
    "items": [
      {
        "id": 1,
        "student_id": 1,
        "student_name": "张三",
        "course_id": 1,
        "course_name": "数学课",
        "date": "2024-01-01",
        "status": "present",
        "check_in_time": "2024-01-01T09:00:00Z",
        "check_out_time": "2024-01-01T10:30:00Z",
        "created_at": "2024-01-01T09:00:00Z"
      }
    ],
    "total": 100,
    "page": 1,
    "page_size": 20,
    "total_pages": 5
  }
}
```

### 2.2 获取考勤记录详情

**接口地址**: `GET /attendance/{record_id}`

**接口描述**: 获取指定考勤记录的详细信息

**权限要求**: admin、teacher

**路径参数**:
- `record_id`: 考勤记录ID

**成功响应**:
```json
{
  "success": true,
  "message": "获取成功",
  "data": {
    "id": 1,
    "student_id": 1,
    "student_name": "张三",
    "student_avatar": "头像URL",
    "course_id": 1,
    "course_name": "数学课",
    "date": "2024-01-01",
    "status": "present",
    "check_in_time": "2024-01-01T09:00:00Z",
    "check_out_time": "2024-01-01T10:30:00Z",
    "notes": "备注信息",
    "created_at": "2024-01-01T09:00:00Z"
  }
}
```

### 2.3 创建考勤记录

**接口地址**: `POST /attendance`

**接口描述**: 创建新的考勤记录

**权限要求**: admin、teacher

**请求参数**:
```json
{
  "student_id": "学生ID",
  "course_id": "课程ID",
  "date": "考勤日期(YYYY-MM-DD)",
  "status": "考勤状态(present/absent/late)",
  "check_in_time": "签到时间(ISO格式)",
  "check_out_time": "签退时间(ISO格式)",
  "notes": "备注信息(可选)"
}
```

**成功响应**:
```json
{
  "success": true,
  "message": "考勤记录创建成功",
  "data": {
    "id": 1,
    "student_id": 1,
    "course_id": 1,
    "date": "2024-01-01",
    "status": "present"
  }
}
```

### 2.4 更新考勤记录

**接口地址**: `PUT /attendance/{record_id}`

**接口描述**: 更新考勤记录信息

**权限要求**: admin、teacher

**路径参数**:
- `record_id`: 考勤记录ID

**请求参数**: 同创建考勤记录

**成功响应**:
```json
{
  "success": true,
  "message": "考勤记录更新成功",
  "data": {
    "id": 1,
    "status": "late",
    "updated_at": "2024-01-01T10:00:00Z"
  }
}
```

### 2.5 删除考勤记录

**接口地址**: `DELETE /attendance/{record_id}`

**接口描述**: 删除考勤记录

**权限要求**: admin

**路径参数**:
- `record_id`: 考勤记录ID

**成功响应**:
```json
{
  "success": true,
  "message": "考勤记录删除成功"
}
```

---

## 3. 学生签到

### 3.1 学生签到

**接口地址**: `POST /attendance/check-in`

**接口描述**: 学生进行签到

**权限要求**: student

**请求参数**:
```json
{
  "course_id": "课程ID",
  "check_in_code": "签到码",
  "location": "签到位置(可选)"
}
```

**成功响应**:
```json
{
  "success": true,
  "message": "签到成功",
  "data": {
    "id": 1,
    "student_id": 1,
    "course_id": 1,
    "date": "2024-01-01",
    "status": "present",
    "check_in_time": "2024-01-01T09:00:00Z"
  }
}
```

### 3.2 学生签退

**接口地址**: `POST /attendance/check-out`

**接口描述**: 学生进行签退

**权限要求**: student

**请求参数**:
```json
{
  "course_id": "课程ID",
  "location": "签退位置(可选)"
}
```

**成功响应**:
```json
{
  "success": true,
  "message": "签退成功",
  "data": {
    "id": 1,
    "check_out_time": "2024-01-01T10:30:00Z"
  }
}
```

### 3.3 获取学生考勤记录

**接口地址**: `GET /attendance/my`

**接口描述**: 学生查看自己的考勤记录

**权限要求**: student

**查询参数**:
- `page`: 页码（默认1）
- `page_size`: 每页大小（默认20）
- `course_id`: 课程ID筛选
- `start_date`: 开始日期（YYYY-MM-DD）
- `end_date`: 结束日期（YYYY-MM-DD）

**成功响应**:
```json
{
  "success": true,
  "message": "获取成功",
  "data": {
    "items": [
      {
        "id": 1,
        "course_id": 1,
        "course_name": "数学课",
        "date": "2024-01-01",
        "status": "present",
        "check_in_time": "2024-01-01T09:00:00Z",
        "check_out_time": "2024-01-01T10:30:00Z"
      }
    ],
    "total": 30,
    "page": 1,
    "page_size": 20,
    "total_pages": 2
  }
}
```

---

## 4. 考勤统计

### 4.1 获取考勤统计信息

**接口地址**: `GET /attendance/statistics`

**接口描述**: 获取考勤统计信息

**权限要求**: admin、teacher

**查询参数**:
- `course_id`: 课程ID筛选
- `student_id`: 学生ID筛选
- `start_date`: 开始日期（YYYY-MM-DD）
- `end_date`: 结束日期（YYYY-MM-DD）

**成功响应**:
```json
{
  "success": true,
  "message": "获取成功",
  "data": {
    "total_records": 150,
    "present_count": 120,
    "absent_count": 20,
    "late_count": 10,
    "attendance_rate": 0.8,
    "by_course": [
      {
        "course_id": 1,
        "course_name": "数学课",
        "total": 50,
        "present": 40,
        "absent": 8,
        "late": 2,
        "rate": 0.8
      }
    ],
    "by_student": [
      {
        "student_id": 1,
        "student_name": "张三",
        "total": 30,
        "present": 25,
        "absent": 3,
        "late": 2,
        "rate": 0.83
      }
    ]
  }
}
```

### 4.2 获取课程考勤统计

**接口地址**: `GET /attendance/course/{course_id}/statistics`

**接口描述**: 获取指定课程的考勤统计

**权限要求**: admin、teacher

**路径参数**:
- `course_id`: 课程ID

**查询参数**:
- `date`: 日期（YYYY-MM-DD，可选）

**成功响应**:
```json
{
  "success": true,
  "message": "获取成功",
  "data": {
    "course_id": 1,
    "course_name": "数学课",
    "date": "2024-01-01",
    "total_students": 30,
    "present_count": 25,
    "absent_count": 3,
    "late_count": 2,
    "attendance_rate": 0.83,
    "student_details": [
      {
        "student_id": 1,
        "student_name": "张三",
        "status": "present",
        "check_in_time": "2024-01-01T09:00:00Z"
      }
    ]
  }
}
```

### 4.3 导出考勤数据

**接口地址**: `GET /attendance/export`

**接口描述**: 导出考勤数据为Excel文件

**权限要求**: admin、teacher

**查询参数**:
- `course_id`: 课程ID筛选
- `start_date`: 开始日期（YYYY-MM-DD）
- `end_date`: 结束日期（YYYY-MM-DD）
- `format`: 导出格式（xlsx/csv）

**成功响应**: Excel文件流

---

## 5. 签到码管理

### 5.1 生成签到码

**接口地址**: `POST /attendance/check-in-code`

**接口描述**: 教师生成课程签到码

**权限要求**: admin、teacher

**请求参数**:
```json
{
  "course_id": "课程ID",
  "expire_minutes": "有效期(分钟，默认30)",
  "max_uses": "最大使用次数(可选)"
}
```

**成功响应**:
```json
{
  "success": true,
  "message": "签到码生成成功",
  "data": {
    "code": "ABC123",
    "course_id": 1,
    "expire_at": "2024-01-01T09:30:00Z",
    "max_uses": 30,
    "used_count": 0
  }
}
```

### 5.2 获取当前签到码

**接口地址**: `GET /attendance/check-in-code/{course_id}`

**接口描述**: 获取课程的当前有效签到码

**权限要求**: admin、teacher

**路径参数**:
- `course_id`: 课程ID

**成功响应**:
```json
{
  "success": true,
  "message": "获取成功",
  "data": {
    "code": "ABC123",
    "course_id": 1,
    "expire_at": "2024-01-01T09:30:00Z",
    "max_uses": 30,
    "used_count": 15,
    "is_valid": true
  }
}
```

### 5.3 验证签到码

**接口地址**: `POST /attendance/verify-code`

**接口描述**: 验证签到码是否有效

**权限要求**: student

**请求参数**:
```json
{
  "course_id": "课程ID",
  "check_in_code": "签到码"
}
```

**成功响应**:
```json
{
  "success": true,
  "message": "验证成功",
  "data": {
    "is_valid": true,
    "course_name": "数学课",
    "expire_at": "2024-01-01T09:30:00Z"
  }
}
```

---

## 6. 错误码说明

| 错误码 | 描述 |
|--------|------|
| VALIDATION_ERROR | 参数验证错误 |
| PERMISSION_DENIED | 权限不足 |
| RESOURCE_NOT_FOUND | 资源不存在 |
| OPERATION_FAILED | 操作失败 |
| INVALID_CHECK_IN_CODE | 签到码无效或已过期 |

## 7. 注意事项

1. **考勤状态说明**:
   - `present`: 正常出勤
   - `absent`: 缺勤
   - `late`: 迟到

2. **签到时间限制**:
   - 学生只能在课程开始前30分钟到课程结束后30分钟内签到
   - 签到码有效期默认为30分钟，教师可自定义

3. **权限控制**:
   - 学生只能查看和操作自己的考勤记录
   - 教师可以管理自己课程的考勤记录
   - 管理员拥有所有权限

4. **数据导出**:
   - 支持Excel和CSV格式导出
   - 导出数据包含详细的考勤信息
   - 大量数据导出可能需要较长时间

5. **签到码安全**:
   - 签到码为6位随机字符
   - 支持设置最大使用次数限制
   - 过期后自动失效 
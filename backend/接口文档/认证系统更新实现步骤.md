# 认证系统更新实现步骤

## 概述
本次更新简化了用户注册和登录流程，实现了以下功能：
- 学生注册：姓名 + 学号(1001开头) + 密码
- 教师注册：姓名 + 教职工号(2001开头) + 密码
- 学生登录：支持姓名或学号
- 教师登录：支持姓名或教职工号
- 自动班级分配：每30人一个班

## 实现步骤

### 第一步：更新用户模型
✅ **已完成**
- 修改 `models/user.py`
- 添加 `get_by_name_or_id()` 方法支持姓名或学号/教职工号查询
- 添加 `check_id_exists()` 方法检查学号/教职工号是否重复
- 添加 `assign_class()` 方法实现自动班级分配
- 更新 `create()` 方法支持新的注册格式

### 第二步：更新认证服务
✅ **已完成**
- 修改 `services/auth_service.py`
- 更新 `login()` 方法支持姓名或学号/教职工号登录
- 更新 `register()` 方法支持新的注册格式
- 添加 `_assign_student_class()` 方法实现班级分配逻辑
- 更新 `get_user_info()` 方法返回新的用户信息格式

### 第三步：更新API接口
✅ **已完成**
- 修改 `api/v1/endpoints/auth.py`
- 更新注册接口参数验证
- 更新登录接口参数验证
- 添加学号/教职工号格式验证
- 完善错误处理

### 第四步：更新数据库结构
✅ **已完成**
- 创建 `init_auth_update.py` 初始化脚本
- 添加 `student_id` 字段（学号）
- 添加 `teacher_id` 字段（教职工号）
- 添加 `class_number` 字段（班级编号）
- 创建相关索引提高查询性能

### 第五步：创建测试脚本
✅ **已完成**
- 创建 `test_auth_update.py` 测试脚本
- 测试学生注册和登录功能
- 测试教师注册和登录功能
- 测试班级分配功能
- 验证所有API接口

### 第六步：创建文档
✅ **已完成**
- 创建 `认证系统更新接口文档.md`
- 创建 `认证系统更新实现步骤.md`
- 提供完整的使用说明和示例

## 核心功能说明

### 1. 注册流程

#### 学生注册
```json
{
    "name": "张三",
    "id_number": "1001001",
    "password": "123456",
    "role": "student"
}
```

#### 教师注册
```json
{
    "name": "李老师",
    "id_number": "2001001",
    "password": "123456",
    "role": "teacher"
}
```

### 2. 登录方式

#### 学生登录
- 支持姓名登录：`{"name_or_id": "张三", "password": "123456", "role": "student"}`
- 支持学号登录：`{"name_or_id": "1001001", "password": "123456", "role": "student"}`

#### 教师登录
- 支持姓名登录：`{"name_or_id": "李老师", "password": "123456", "role": "teacher"}`
- 支持教职工号登录：`{"name_or_id": "2001001", "password": "123456", "role": "teacher"}`

### 3. 班级分配规则

#### 自动分配逻辑
- 学生注册时自动分配到班级
- 每30人一个班级
- 班级编号从1开始递增
- 当前班级未满时，新学生分配到当前班级
- 当前班级已满时，创建新班级

#### 分配示例
```
学生1-30 -> 班级1
学生31-60 -> 班级2
学生61-90 -> 班级3
...
```

## 数据库结构更新

### 新增字段
```sql
ALTER TABLE users ADD COLUMN student_id TEXT;
ALTER TABLE users ADD COLUMN teacher_id TEXT;
ALTER TABLE users ADD COLUMN class_number INTEGER;
```

### 新增索引
```sql
-- 学号唯一索引
CREATE UNIQUE INDEX idx_student_id ON users(student_id) WHERE student_id IS NOT NULL;

-- 教职工号唯一索引
CREATE UNIQUE INDEX idx_teacher_id ON users(teacher_id) WHERE teacher_id IS NOT NULL;

-- 姓名角色复合索引
CREATE INDEX idx_name_role ON users(name, role);

-- 班级编号索引
CREATE INDEX idx_class_number ON users(class_number) WHERE class_number IS NOT NULL;
```

## 使用方法

### 1. 初始化
```bash
python init_auth_update.py
```

### 2. 测试功能
```bash
python test_auth_update.py
```

### 3. 注册用户
```bash
# 学生注册
curl -X POST http://localhost:5000/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{"name": "张三", "id_number": "1001001", "password": "123456", "role": "student"}'

# 教师注册
curl -X POST http://localhost:5000/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{"name": "李老师", "id_number": "2001001", "password": "123456", "role": "teacher"}'
```

### 4. 用户登录
```bash
# 学生登录（姓名）
curl -X POST http://localhost:5000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"name_or_id": "张三", "password": "123456", "role": "student"}'

# 学生登录（学号）
curl -X POST http://localhost:5000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"name_or_id": "1001001", "password": "123456", "role": "student"}'
```

## 技术特点

### 简化设计
- 注册流程只需3个字段：姓名、学号/教职工号、密码
- 登录支持姓名或学号/教职工号，更加灵活
- 自动班级分配，无需手动管理

### 数据验证
- 学号必须以1001开头
- 教职工号必须以2001开头
- 防止重复注册
- 完善的错误处理

### 性能优化
- 创建必要索引提高查询性能
- 支持姓名或学号/教职工号快速查询
- 班级分配逻辑优化

## 注意事项

1. **学号格式**：学生学号必须以 `1001` 开头
2. **教职工号格式**：教师教职工号必须以 `2001` 开头
3. **班级分配**：只有学生会被分配到班级，教师不分配班级
4. **登录方式**：支持姓名或学号/教职工号登录，更加灵活
5. **数据迁移**：现有用户数据可能需要手动迁移
6. **向后兼容**：保留了原有的API接口，确保系统稳定性

## 后续优化建议

1. **批量导入**：支持批量导入学生和教师信息
2. **班级管理**：添加班级管理功能，支持手动调整班级
3. **密码策略**：实现密码强度验证和定期更换
4. **登录日志**：记录用户登录日志，便于安全审计
5. **多因素认证**：支持短信验证码等双因素认证

## 总结

本次认证系统更新成功实现了简化的注册登录流程，支持灵活的登录方式，并实现了自动班级分配功能。整个系统更加用户友好，操作流程更加简化，为后续的功能扩展奠定了良好的基础。 
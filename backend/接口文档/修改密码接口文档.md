# 修改密码接口文档

## 概述

修改密码功能允许已登录的用户修改自己的登录密码。修改密码后，系统会自动清除用户的所有刷新令牌，强制用户重新登录以确保安全性。

## 接口信息

- **接口路径**: `/api/v1/auth/change-password`
- **请求方法**: `PUT`
- **需要认证**: 是（需要JWT访问令牌）
- **内容类型**: `application/json`

## 请求参数

### 请求头

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| Authorization | string | 是 | Bearer令牌，格式：`Bearer {access_token}` |
| Content-Type | string | 是 | 固定值：`application/json` |

### 请求体

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| old_password | string | 是 | 当前密码 | "current123" |
| new_password | string | 是 | 新密码 | "newpass456" |

### 新密码格式要求

- 长度：6-50位字符
- 必须包含至少一个数字
- 必须包含至少一个字母
- 不能与旧密码相同

## 响应格式

### 成功响应

**状态码**: `200 OK`

```json
{
  "success": true,
  "code": 200,
  "message": "操作成功",
  "data": {
    "message": "密码修改成功，请重新登录",
    "user_id": 123
  }
}
```

### 错误响应

#### 1. 缺少必填字段

**状态码**: `400 Bad Request`

```json
{
  "success": false,
  "code": 400,
  "message": "缺少必填字段: old_password, new_password"
}
```

#### 2. 旧密码错误

**状态码**: `401 Unauthorized`

```json
{
  "success": false,
  "code": 401,
  "message": "旧密码错误"
}
```

#### 3. 密码格式错误

**状态码**: `400 Bad Request`

```json
{
  "success": false,
  "code": 400,
  "message": "密码长度不能少于6位"
}
```

```json
{
  "success": false,
  "code": 400,
  "message": "密码必须包含至少一个数字"
}
```

```json
{
  "success": false,
  "code": 400,
  "message": "密码必须包含至少一个字母"
}
```

#### 4. 新密码与旧密码相同

**状态码**: `400 Bad Request`

```json
{
  "success": false,
  "code": 400,
  "message": "新密码不能与旧密码相同"
}
```

#### 5. 用户不存在

**状态码**: `404 Not Found`

```json
{
  "success": false,
  "code": 404,
  "message": "用户不存在"
}
```

#### 6. 未授权访问

**状态码**: `401 Unauthorized`

```json
{
  "success": false,
  "code": 401,
  "message": "缺少访问令牌"
}
```

## 使用示例

### cURL示例

```bash
curl -X PUT \
  http://localhost:5000/api/v1/auth/change-password \
  -H 'Authorization: Bearer your_access_token_here' \
  -H 'Content-Type: application/json' \
  -d '{
    "old_password": "current123",
    "new_password": "newpass456"
  }'
```

### JavaScript示例

```javascript
const changePassword = async (oldPassword, newPassword) => {
  try {
    const response = await fetch('/api/v1/auth/change-password', {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        old_password: oldPassword,
        new_password: newPassword
      })
    });
    
    const result = await response.json();
    
    if (response.ok) {
      console.log('密码修改成功:', result.data.message);
      // 密码修改成功后，清除本地存储的令牌，跳转到登录页
      localStorage.removeItem('access_token');
      localStorage.removeItem('refresh_token');
      window.location.href = '/login';
    } else {
      console.error('密码修改失败:', result.message);
    }
  } catch (error) {
    console.error('请求失败:', error);
  }
};
```

### Python示例

```python
import requests

def change_password(access_token, old_password, new_password):
    url = "http://localhost:5000/api/v1/auth/change-password"
    headers = {
        "Authorization": f"Bearer {access_token}",
        "Content-Type": "application/json"
    }
    data = {
        "old_password": old_password,
        "new_password": new_password
    }
    
    try:
        response = requests.put(url, json=data, headers=headers)
        result = response.json()
        
        if response.status_code == 200:
            print("密码修改成功:", result['data']['message'])
            return True
        else:
            print("密码修改失败:", result['message'])
            return False
    except Exception as e:
        print("请求失败:", str(e))
        return False
```

## 安全说明

1. **密码加密**: 新密码使用bcrypt算法进行加密存储
2. **令牌清除**: 修改密码后自动清除所有刷新令牌，强制重新登录
3. **密码复杂度**: 要求密码包含数字和字母，提高安全性
4. **日志记录**: 系统会记录密码修改操作（可选功能）
5. **兼容性**: 支持旧系统的明文密码验证

## 注意事项

1. 修改密码后，用户需要重新登录
2. 建议前端在密码修改成功后清除本地存储的令牌
3. 密码修改操作会记录在系统日志中
4. 新密码不能与旧密码相同
5. 密码格式验证在服务端进行，确保安全性

## 错误码说明

| 错误码 | 说明 |
|--------|------|
| 400 | 请求参数错误（缺少字段、格式错误等） |
| 401 | 认证失败（令牌无效、旧密码错误等） |
| 404 | 资源不存在（用户不存在） |
| 500 | 服务器内部错误 |

# 后端功能结构说明

## 总览
- **技术栈**: Flask + Flask-JWT-Extended + Flask-CORS + Flask-SocketIO + SQLite
- **API 前缀**: `/api/v1`
- **分层**: 应用入口(app) → 路由(API) → 业务逻辑(services) → 数据访问(models/core.helpers) → 公共(core/utils) → 脚本(scripts)

目录速览（简化）
```
backend/
├── app.py                 # 应用入口、全局中间件、路由注册、SocketIO
├── api/                   # API 路由层（v1 版）
│   └── v1/
│       ├── api.py         # 注册蓝图及汇总所有 endpoints
│       └── endpoints/     # 具体模块的 REST 接口
├── core/                  # 核心：认证装饰器、错误码与统一响应、DB 帮助函数
├── models/                # 数据模型与领域对象（基于 sqlite3）
├── services/              # 业务服务层：聚合校验、组合模型操作
├── utils/                 # 通用工具（日期、文件处理等）
├── scripts/               # 数据导入导出、初始化、测试脚本
├── uploads/               # 上传文件保存目录
├── database.db            # SQLite 数据库文件
└── requirements.txt       # 依赖
```

## 运行入口
- **`app.py`**
  - 创建 Flask 应用与 `SocketIO`、开启 CORS。
  - 配置 JWT（密钥、过期时间、Header 位置与类型），并注册 JWT 错误处理（过期、无效、缺失等）。
  - 全局错误处理：捕获 `ApiError` 与未预期异常，统一返回格式化错误响应。
  - `register_routes(app)`：挂载 v1 API 蓝图。
  - SocketIO 事件：`connect`/`disconnect`/`join`/`leave`/`message`。
  - 应用关闭时调用 `core.helpers.close_db` 释放连接。

## 核心模块 core/
- **`auth.py`**: 登录与角色校验装饰器
  - `login_required(fn)`: 校验 JWT 是否存在且有效。
  - `role_required(role)` / `roles_required(roles)`: 从 `get_jwt_identity()` 解析身份与角色，校验权限。
- **`errors.py`**: 错误码与统一异常
  - `ErrorCode`: 标准 HTTP 类错误、业务错误(1001+)及消息映射。
  - `ApiError`: 业务异常，包含 `code`/`message`/`payload`。
- **`responses.py`**: 统一返回
  - `ok_response(data, message, code, meta, http_status)`
  - `error_response(message, code, payload, http_status)`：按错误码推断 HTTP 状态。
- **`helpers.py`**: DB 与校验工具
  - DB 连接与封装：`get_db`、`db_execute/fetch_one/fetch_all/insert/update/delete`。
  - 字段校验：`validate_required/field/datetime`。
  - 认证辅助：`create_tokens`（创建并持久化 refresh token）、`get_user_info`。

## API 路由层 api/v1/
- **`api.py`**: 定义蓝图 `api`（前缀 `/api/v1`），导入并注册所有 `endpoints` 模块。
- **`endpoints/`**: 每个文件对应一个业务域的 REST API。
  - `auth.py`: 登录、注册、登出、修改密码、刷新令牌等认证相关接口。
  - `students.py`: 学生管理相关接口（信息、查询、统计等）。
  - `study.py`: 学习与练习相关接口（学习记录、进度、成绩等）。
  - `materials.py`: 教学资源接口（上传、管理、查询、预览等）。
  - `messages.py`: 消息中心接口（站内信/通知的创建、读取、列表）。
  - `user_profile.py`: 用户画像/档案相关接口（基本信息、偏好、标签）。
  - `avatar.py`: 头像上传/裁剪/更新接口。
  - `daily_checkin.py`: 每日签到与积分相关接口。
  - `cards.py`: 卡牌系统、抽卡、卡片信息接口。
  - `ai.py`: AI 助手/生物问答相关接口（适配 `services.ai_service`）。

接口层职责：
- 解析与校验输入（必要字段、简单格式）。
- 调用 `services` 完成业务处理。
- 使用 `ok_response/error_response` 返回统一结构。

## 业务服务层 services/
- 作用：承上启下，聚合多个模型/外部适配的操作；包含业务校验、权限与边界判断；保证事务式更新（在本项目中通过顺序 DB 操作与错误回滚约束）。
- 常用文件：
  - `auth_service.py`: 登录/注册/令牌创建与刷新/登出；密码哈希校验；用户信息聚合。
  - `student_service.py`: 学生信息查询与统计、积分变更等。
  - `study_service.py`: 学习记录、进度、错题/练习等业务。
  - `material_service.py`: 教学资源的存储、元数据管理、权限校验。
  - `message_service.py`: 通知/消息的创建、列表、既读状态更新等。
  - `user_profile_service.py`: 用户画像的读取/更新、偏好标签等。
  - `avatar_service.py`: 头像文件处理、裁剪、URL 生成与更新。
  - `daily_checkin_service.py`: 签到、积分发放与规则限制。
  - `card_service.py`: 卡牌/卡池/抽卡逻辑、概率/库存等。
  - `ai_service.py`: AI 能力封装（与 `biology_qa_adapter.py` 交互）。
  - `biology_qa_adapter.py`: 对接生物问答适配层。

## 数据模型层 models/
- 基础：使用 `sqlite3`，`models/base.py` 提供 `BaseModel` 与 `dict_from_row`，路径 `DATABASE` 指向 `backend/database.db`。
- 领域模型（按表/主题划分，提供查询或简易 CRUD）：
  - `user.py`: 用户查询、创建、班级分配、积分增减等。
  - `student.py`: 学生相关信息（与用户表/班级/统计相关）。
  - `study.py`: 学习记录/进度等。
  - `practice.py`: 练习/题目关联数据。
  - `message.py`: 消息/通知数据。
  - `material.py`: 教学资源元数据与索引。
  - `category.py`: 资源/题目分类数据。
  - `daily_checkin.py`: 签到记录与计数。
  - `card_system.py`: 卡牌/卡池/稀有度/抽取记录等。
  - `user_profile.py`: 用户画像/偏好配置。
  - `base.py`: 基础连接与 Row→dict 转换。

## 工具与公共 utils/
- `date_utils.py`: 时间获取/格式化/解析、学年与学期推断等。
- `file_utils.py`: 文件名校验/唯一名生成/MIME 与大小格式化/目录确保等。

## 脚本 scripts/
- 用途：环境初始化、数据导入导出、一次性修复、验证与集成测试等。
- 典型脚本：
  - `import_db.py` / `export_db.py`: 数据库导入导出。
  - `init_*` 系列：初始化认证、头像、卡牌系统、用户画像等。
  - `update_*` 系列：批量更新卡牌/教师班级/资源链接等数据。
  - `verify_card_images.py`: 验证卡牌图片有效性。
  - `test_*.py`: 针对 API 与核心函数的集成/单元测试示例。

## 统一认证与返回约定
- 认证：JWT Bearer Token（Header: `Authorization: Bearer <token>`）。
  - 访问令牌有效期默认 1 小时；刷新令牌有效期默认 30 天（持久化到 `refresh_tokens` 表）。
  - 装饰器：`@jwt_required()`（端点级），或 `core.auth` 中的 `login_required/role_required/roles_required`。
- 返回：统一 JSON Envelope
  - 成功：`{ code, message, data, meta? }`（`ok_response`）
  - 失败：`{ code, message, data }`（`error_response`），HTTP 状态随错误码推断。
  - 错误码：见 `core.errors.ErrorCode`。

## 典型请求处理流程
1. 客户端请求 `POST /api/v1/auth/login`（举例）。
2. `endpoints/auth.py` 解析必填字段，调用 `services.auth_service.login`。
3. `auth_service` 校验用户、密码与角色，生成 token，读取用户信息。
4. 服务层使用 `core.helpers.db_*` 访问 `database.db`。
5. 控制器通过 `ok_response` 返回统一结构；异常通过 `ApiError`/全局捕获转成 `error_response`。

## 其他
- `requirements.txt`: Python 依赖清单。
- `uploads/`: 用户上传文件保存位置（由 `app.py` 的 `UPLOAD_FOLDER` 控制）。
- `database.db`: SQLite 数据文件（开发/演示环境）。 
# 头像功能接口文档

## 概述

头像功能允许用户上传、管理个人头像图片，支持图片压缩、格式转换等功能。

## 功能特点

### 1. 文件支持
- **支持格式**: PNG、JPG、JPEG、GIF、WEBP
- **文件大小**: 最大5MB
- **图片处理**: 自动压缩、调整大小（最大200x200像素）

### 2. 安全特性
- **文件名安全**: 自动生成唯一文件名，防止冲突
- **类型验证**: 严格验证文件类型和大小
- **权限控制**: 只能操作自己的头像

### 3. 存储管理
- **自动清理**: 上传新头像时自动删除旧头像
- **文件记录**: 记录头像文件的详细信息
- **静态服务**: 提供头像文件的直接访问

## API接口

### 1. 上传头像

**接口地址**: `POST /api/v1/users/avatar`

**接口描述**: 上传用户头像

**权限要求**: 需要登录认证

**请求参数**:
- `avatar` (文件): 头像图片文件

**请求示例**:
```bash
curl -X POST http://localhost:5000/api/v1/users/avatar \
  -H 'Authorization: Bearer YOUR_TOKEN' \
  -F 'avatar=@/path/to/your/image.jpg'
```

**成功响应**:
```json
{
  "success": true,
  "message": "头像上传成功",
  "data": {
    "avatar_url": "/uploads/avatars/abc123def456.jpg",
    "message": "头像上传成功"
  }
}
```

**错误响应**:
```json
{
  "success": false,
  "message": "不支持的文件类型，支持的类型: png, jpg, jpeg, gif, webp",
  "code": "VALIDATION_ERROR"
}
```

### 2. 获取用户头像

**接口地址**: `GET /api/v1/users/avatar/{user_id}`

**接口描述**: 获取指定用户的头像URL

**权限要求**: 需要登录认证

**路径参数**:
- `user_id` (整数): 用户ID

**成功响应**:
```json
{
  "success": true,
  "message": "获取头像成功",
  "data": {
    "avatar_url": "/uploads/avatars/abc123def456.jpg"
  }
}
```

**无头像响应**:
```json
{
  "success": true,
  "message": "用户没有头像",
  "data": {
    "avatar_url": null
  }
}
```

### 3. 获取头像详细信息

**接口地址**: `GET /api/v1/users/avatar/{user_id}/info`

**接口描述**: 获取头像的详细信息

**权限要求**: 需要登录认证

**路径参数**:
- `user_id` (整数): 用户ID

**成功响应**:
```json
{
  "success": true,
  "message": "获取头像信息成功",
  "data": {
    "avatar_info": {
      "avatar_url": "/uploads/avatars/abc123def456.jpg",
      "filename": "abc123def456.jpg",
      "original_filename": "my_avatar.jpg",
      "file_size": 24576,
      "mime_type": "image/jpeg",
      "created_at": "2024-01-15 14:30:00"
    }
  }
}
```

### 4. 删除头像

**接口地址**: `DELETE /api/v1/users/avatar`

**接口描述**: 删除当前用户的头像

**权限要求**: 需要登录认证

**成功响应**:
```json
{
  "success": true,
  "message": "头像删除成功",
  "data": {
    "message": "头像删除成功"
  }
}
```

### 5. 更新头像

**接口地址**: `PUT /api/v1/users/avatar`

**接口描述**: 更新用户头像（重新上传）

**权限要求**: 需要登录认证

**请求参数**:
- `avatar` (文件): 新的头像图片文件

**成功响应**:
```json
{
  "success": true,
  "message": "头像更新成功",
  "data": {
    "avatar_url": "/uploads/avatars/new_abc123def456.jpg",
    "message": "头像更新成功"
  }
}
```

### 6. 访问头像文件

**接口地址**: `GET /uploads/avatars/{filename}`

**接口描述**: 直接访问头像文件

**权限要求**: 无需认证

**路径参数**:
- `filename` (字符串): 头像文件名

**响应**: 直接返回图片文件

## 数据库结构

### users表新增字段
```sql
ALTER TABLE users ADD COLUMN avatar_url TEXT;
```

### avatar_files表
```sql
CREATE TABLE avatar_files (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    filename TEXT NOT NULL,
    original_filename TEXT NOT NULL,
    file_size INTEGER NOT NULL,
    mime_type TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE
);
```

## 使用流程

### 1. 初始化
```bash
# 运行初始化脚本
python scripts/init_avatar.py
```

### 2. 上传头像
```bash
# 使用curl上传
curl -X POST http://localhost:5000/api/v1/users/avatar \
  -H 'Authorization: Bearer YOUR_TOKEN' \
  -F 'avatar=@/path/to/your/image.jpg'
```

### 3. 获取头像
```bash
# 获取头像URL
curl -X GET http://localhost:5000/api/v1/users/avatar/123 \
  -H 'Authorization: Bearer YOUR_TOKEN'
```

### 4. 删除头像
```bash
# 删除头像
curl -X DELETE http://localhost:5000/api/v1/users/avatar \
  -H 'Authorization: Bearer YOUR_TOKEN'
```

## 前端集成示例

### JavaScript上传示例
```javascript
async function uploadAvatar(file) {
  const formData = new FormData();
  formData.append('avatar', file);
  
  const response = await fetch('/api/v1/users/avatar', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
    },
    body: formData
  });
  
  const result = await response.json();
  if (result.success) {
    console.log('头像上传成功:', result.data.avatar_url);
  }
}
```

### 显示头像示例
```html
<img src="/uploads/avatars/abc123def456.jpg" alt="用户头像" />
```

## 错误码说明

| 错误码 | 描述 |
|--------|------|
| VALIDATION_ERROR | 参数验证错误（文件类型、大小等） |
| RESOURCE_NOT_FOUND | 用户不存在 |
| OPERATION_FAILED | 操作失败 |
| INVALID_CREDENTIALS | 认证失败 |

## 注意事项

### 1. 文件限制
- 只支持图片格式：PNG、JPG、JPEG、GIF、WEBP
- 文件大小限制：5MB
- 图片会自动压缩到200x200像素

### 2. 存储管理
- 头像文件存储在 `uploads/avatars/` 目录
- 上传新头像时会自动删除旧头像
- 删除用户时会自动删除相关头像文件

### 3. 安全考虑
- 文件名使用UUID生成，防止路径遍历攻击
- 严格验证文件类型和大小
- 用户只能操作自己的头像

### 4. 性能优化
- 图片自动压缩减少存储空间
- 使用静态文件服务提供快速访问
- 数据库索引优化查询性能

## 测试

### 运行测试脚本
```bash
python scripts/test_avatar.py
```

### 手动测试
```bash
# 1. 启动后端服务
python app.py

# 2. 运行初始化脚本
python scripts/init_avatar.py

# 3. 测试上传头像
curl -X POST http://localhost:5000/api/v1/users/avatar \
  -H 'Authorization: Bearer YOUR_TOKEN' \
  -F 'avatar=@test_image.jpg'
```

## 依赖要求

### Python包
```bash
pip install Pillow  # 图片处理
```

### 系统要求
- 支持的文件系统
- 足够的存储空间
- 适当的文件权限

## 扩展功能

### 1. 头像裁剪
可以添加前端裁剪功能，让用户选择头像区域。

### 2. 多种尺寸
可以生成多种尺寸的头像（缩略图、大图等）。

### 3. 云存储
可以将头像存储到云存储服务（如阿里云OSS、腾讯云COS等）。

### 4. CDN加速
可以使用CDN加速头像文件的访问。

### 5. 头像审核
可以添加头像内容审核功能，确保头像内容合规。

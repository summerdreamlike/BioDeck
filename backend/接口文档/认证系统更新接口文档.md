# 认证系统更新接口文档

## 概述

本次更新简化了用户注册和登录流程，支持学生和教师使用姓名或学号/教职工号进行登录，并实现了自动班级分配功能。

## 主要更新

### 1. 注册流程简化
- **学生注册**：姓名 + 学号(1001开头) + 密码
- **教师注册**：姓名 + 教职工号(2001开头) + 密码
- **自动班级分配**：学生注册时自动分配到班级（每30人一个班）

### 2. 登录方式优化
- **学生登录**：支持姓名或学号登录
- **教师登录**：支持姓名或教职工号登录

### 3. 数据库结构更新
- 添加 `student_id` 字段（学号）
- 添加 `teacher_id` 字段（教职工号）
- 添加 `class_number` 字段（班级编号）
- 创建相关索引提高查询性能

## API接口

### 1. 用户注册

**接口地址：** `POST /api/v1/auth/register`

**请求参数：**
```json
{
    "name": "张三",
    "id_number": "1001001",
    "password": "123456",
    "role": "student"
}
```

**参数说明：**
- `name` (必填): 用户姓名
- `id_number` (必填): 学号或教职工号
  - 学生学号必须以 `1001` 开头
  - 教师教职工号必须以 `2001` 开头
- `password` (必填): 密码
- `role` (必填): 用户角色，只能是 `student` 或 `teacher`

**响应示例：**
```json
{
    "code": 200,
    "message": "注册成功",
    "data": {
        "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "refresh_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "user": {
            "id": 1,
            "name": "张三",
            "role": "student",
            "student_id": "1001001",
            "class_number": 1
        }
    }
}
```

### 2. 用户登录

**接口地址：** `POST /api/v1/auth/login`

**请求参数：**
```json
{
    "name_or_id": "张三",
    "password": "123456",
    "role": "student"
}
```

**参数说明：**
- `name_or_id` (必填): 姓名或学号/教职工号
  - 学生：支持姓名或学号
  - 教师：支持姓名或教职工号
- `password` (必填): 密码
- `role` (必填): 用户角色

**响应示例：**
```json
{
    "code": 200,
    "message": "登录成功",
    "data": {
        "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "refresh_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "user": {
            "id": 1,
            "name": "张三",
            "role": "student",
            "student_id": "1001001",
            "class_number": 1
        }
    }
}
```

### 3. 令牌刷新

**接口地址：** `POST /api/v1/auth/refresh`

**请求参数：**
```json
{
    "refresh_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
}
```

**响应示例：**
```json
{
    "code": 200,
    "message": "令牌刷新成功",
    "data": {
        "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "user": {
            "id": 1,
            "name": "张三",
            "role": "student",
            "student_id": "1001001",
            "class_number": 1
        }
    }
}
```

### 4. 用户登出

**接口地址：** `POST /api/v1/auth/logout`

**请求头：**
```
Authorization: Bearer <access_token>
```

**响应示例：**
```json
{
    "code": 200,
    "message": "登出成功",
    "data": {
        "message": "登出成功"
    }
}
```

## 使用示例

### 学生注册和登录

**1. 学生注册**
```bash
curl -X POST http://localhost:5000/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "name": "张三",
    "id_number": "1001001",
    "password": "123456",
    "role": "student"
  }'
```

**2. 学生登录（使用姓名）**
```bash
curl -X POST http://localhost:5000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "name_or_id": "张三",
    "password": "123456",
    "role": "student"
  }'
```

**3. 学生登录（使用学号）**
```bash
curl -X POST http://localhost:5000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "name_or_id": "1001001",
    "password": "123456",
    "role": "student"
  }'
```

### 教师注册和登录

**1. 教师注册**
```bash
curl -X POST http://localhost:5000/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "name": "李老师",
    "id_number": "2001001",
    "password": "123456",
    "role": "teacher"
  }'
```

**2. 教师登录（使用姓名）**
```bash
curl -X POST http://localhost:5000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "name_or_id": "李老师",
    "password": "123456",
    "role": "teacher"
  }'
```

**3. 教师登录（使用教职工号）**
```bash
curl -X POST http://localhost:5000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "name_or_id": "2001001",
    "password": "123456",
    "role": "teacher"
  }'
```

## 班级分配规则

### 自动班级分配
- 学生注册时自动分配到班级
- 每30人一个班级
- 班级编号从1开始递增
- 当前班级未满时，新学生分配到当前班级
- 当前班级已满时，创建新班级

### 班级分配示例
```
学生1-30 -> 班级1
学生31-60 -> 班级2
学生61-90 -> 班级3
...
```

## 错误处理

### 常见错误码

**400 - 参数错误**
```json
{
    "code": 400,
    "message": "学号必须以1001开头",
    "data": null
}
```

**409 - 重复注册**
```json
{
    "code": 409,
    "message": "学号已存在",
    "data": null
}
```

**401 - 认证失败**
```json
{
    "code": 401,
    "message": "用户不存在或密码错误",
    "data": null
}
```

## 数据库结构

### users表新增字段
```sql
ALTER TABLE users ADD COLUMN student_id TEXT;
ALTER TABLE users ADD COLUMN teacher_id TEXT;
ALTER TABLE users ADD COLUMN class_number INTEGER;
```

### 索引优化
```sql
-- 学号唯一索引
CREATE UNIQUE INDEX idx_student_id ON users(student_id) WHERE student_id IS NOT NULL;

-- 教职工号唯一索引
CREATE UNIQUE INDEX idx_teacher_id ON users(teacher_id) WHERE teacher_id IS NOT NULL;

-- 姓名角色复合索引
CREATE INDEX idx_name_role ON users(name, role);

-- 班级编号索引
CREATE INDEX idx_class_number ON users(class_number) WHERE class_number IS NOT NULL;
```

## 初始化步骤

### 1. 运行初始化脚本
```bash
python init_auth_update.py
```

### 2. 测试功能
```bash
python test_auth_update.py
```

## 注意事项

1. **学号格式**：学生学号必须以 `1001` 开头
2. **教职工号格式**：教师教职工号必须以 `2001` 开头
3. **班级分配**：只有学生会被分配到班级，教师不分配班级
4. **登录方式**：支持姓名或学号/教职工号登录，更加灵活
5. **数据迁移**：现有用户数据可能需要手动迁移
6. **向后兼容**：保留了原有的API接口，确保系统稳定性

## 更新日志

- ✅ 简化注册流程，只需姓名、学号/教职工号、密码
- ✅ 支持姓名或学号/教职工号登录
- ✅ 实现自动班级分配功能
- ✅ 优化数据库结构，添加必要字段和索引
- ✅ 完善错误处理和参数验证
- ✅ 提供完整的测试脚本和文档 